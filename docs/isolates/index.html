<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-alpha.63">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-180710528-1","auto"),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="search" type="application/opensearchdescription+xml" title="Ferry Graphql" href="/opensearch.xml"><title data-react-helmet="true">Running the client in a separate isolate | Ferry Graphql</title><meta data-react-helmet="true" name="docsearch:version" content="current,latest"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:title" content="Running the client in a separate isolate | Ferry Graphql"><meta data-react-helmet="true" name="description" content="Running the client in a separate isolate"><meta data-react-helmet="true" property="og:description" content="Running the client in a separate isolate"><meta data-react-helmet="true" property="og:url" content="https://ferrygraphql.com/docs/isolates"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="preconnect" href="https://BH4D9OD16A-dsn.algolia.net" crossorigin="true"><link data-react-helmet="true" rel="canonical" href="https://ferrygraphql.com/docs/isolates"><link rel="stylesheet" href="/styles.b24e737a.css">
<link rel="preload" href="/styles.f1bdf990.js" as="script">
<link rel="preload" href="/runtime~main.e864399f.js" as="script">
<link rel="preload" href="/main.60635ab2.js" as="script">
<link rel="preload" href="/1.27e33db8.js" as="script">
<link rel="preload" href="/2.040e9cea.js" as="script">
<link rel="preload" href="/27.30f434e1.js" as="script">
<link rel="preload" href="/30.fdbdcc2e.js" as="script">
<link rel="preload" href="/935f2afb.03ea0236.js" as="script">
<link rel="preload" href="/17896441.ff7edf47.js" as="script">
<link rel="preload" href="/ad3276bd.0c495063.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<nav class="navbar navbar--light navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><div aria-label="Navigation bar toggle" class="navbar__toggle" role="button" tabindex="0"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></div><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="Ferry Logo"><strong class="navbar__title">Ferry</strong></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/docs/">Docs</a><a href="https://github.com/gql-dart/ferry/tree/master/examples" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Examples</a></div><div class="navbar__items navbar__items--right"><a href="https://pub.dev/packages/ferry" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">pub.dev</a><a href="https://github.com/gql-dart/ferry" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><div class="react-toggle react-toggle--disabled displayOnlyInLargeViewport_2aTZ"><div class="react-toggle-track"><div class="react-toggle-track-check"><span class="toggle_BsTx">ðŸŒœ</span></div><div class="react-toggle-track-x"><span class="toggle_BsTx">ðŸŒž</span></div></div><div class="react-toggle-thumb"></div><input type="checkbox" disabled="" aria-label="Dark mode toggle" class="react-toggle-screenreader-only"></div><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span><span class="DocSearch-Button-Key">âŒ˜</span><span class="DocSearch-Button-Key">K</span></button></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img class="navbar__logo" src="/img/logo.svg" alt="Ferry Logo"><strong class="navbar__title">Ferry</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/docs/">Docs</a></li><li class="menu__list-item"><a href="https://github.com/gql-dart/ferry/tree/master/examples" target="_blank" rel="noopener noreferrer" class="menu__link">Examples</a></li><li class="menu__list-item"><a href="https://pub.dev/packages/ferry" target="_blank" rel="noopener noreferrer" class="menu__link">pub.dev</a></li><li class="menu__list-item"><a href="https://github.com/gql-dart/ferry" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li></ul></div></div></div></nav><div class="main-wrapper"><div class="docPage_2gpo"><div class="docSidebarContainer_3_JD" role="complementary"><div class="sidebar_2urC"><div class="menu menu--responsive menu_5FrY"><button aria-label="Open Menu" aria-haspopup="true" class="button button--secondary button--sm menu__button" type="button"><svg aria-label="Menu" class="sidebarMenuIcon_Dm3K" xmlns="http://www.w3.org/2000/svg" height="24" width="24" viewBox="0 0 32 32" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><ul class="menu__list"><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Ferry</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/">Introduction</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/how-it-works">How It Works</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Getting Started</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/setup">Setup</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/codegen">Generate Classes</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Fetching</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/queries">Queries</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/mutations">Mutations</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/fetch-policies">Fetch Policies</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/pagination">Pagination &amp; Refetching</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/error-handling">Error Handling</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Caching</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cache-configuration">Configuration</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/cache-interaction">Reading and Writing</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/garbage-collection">Garbage Collection &amp; Eviction</a></li></ul></li><li class="menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#!">Flutter</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter">Using with Flutter</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/flutter-operation-widget">Operation Widget</a></li><li class="menu__list-item"><a class="menu__link" tabindex="-1" href="/docs/structuring-queries">Structuring Queries</a></li></ul></li><li class="menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#!">Advanced</a><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/custom-scalars">Custom Scalars</a></li><li class="menu__list-item"><a class="menu__link" tabindex="0" href="/docs/customization">Customizing the Client</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link menu__link--active active" tabindex="0" href="/docs/isolates">Isolates</a></li></ul></li></ul></div></div></div><main class="docMainContainer_3EyW"><div class="container padding-vert--lg docItemWrapper_1EkI"><div class="row"><div class="col docItemCol_2ASc"><div class="docItemContainer_3QWW"><article><header><h1 class="docTitle_1Lrw">Running the client in a separate isolate</h1></header><div class="markdown"><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="running-the-client-in-a-separate-isolate"></a>Running the client in a separate isolate<a aria-hidden="true" tabindex="-1" class="hash-link" href="#running-the-client-in-a-separate-isolate" title="Direct link to heading">#</a></h2><p>The default setup should be sufficient for most use cases.
However, normalization and denormalization of big, nested responses can be quite computation heavy
and can lead to dropped frames on frontends.</p><p>Ferry can help you run your graphql-related code on a separate isolate so that the UI thread does
not get blocked when executing big queries.</p><p>Since the Ferry <code>Client</code> already is Stream based, the differences in the API between the default <code>Client</code> and the <code>IsolateClient</code> are minimal.
If you are just using the <code>request()</code> method of the <code>Client</code> or <code>Operation</code> widgets of ferry_flutter,
then the <code>IsolateClient</code> is a drop-in replacement! </p><p>The <code>IsolateClient</code> does not, however, offer direct access to the <code>Cache</code> object, but instead offers
indirect access via methods like <code>readQuery()</code> or <code>writeFragment()</code>. These methods are asynchronous,
as all communication over isolates is asynchrounous.</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="setup"></a>Setup<a aria-hidden="true" tabindex="-1" class="hash-link" href="#setup" title="Direct link to heading">#</a></h3><p>To run Ferry on a separate Isolate, use the static <code>IsolateClient.create&lt;InitParams&gt;()</code> method.
This method receives three parameters and one generic type parameter:</p><ul><li><code>&lt;InitParams&gt;</code>: this generic type parameter defines the type of the parameters object which is used
to initialze the client. If you don&#x27;t want to write a separate class for this, you can just use <code>Map&lt;String, dynamic&gt;</code> here.
If you don&#x27;t need parameters to initialize the Client, you can also use the <code>Null</code> type</li><li><code>initClient</code>: This function is called on a separate isolate and is responsible for creating the real Ferry <code>Client</code>.
This must be a top-level or static function (otherwise it will not be possible to send it to another isolate).
When migrating from the standard setup to to isolate-based setup, move the initialization of the <code>Client</code> class
to this function. initClient is also called with a <code>SendPort</code> parameter, which can be used to establish custom
communication between the two isolates. You can use this for example for synchronizing authentication tokens when
the are refreshed. </li><li><code>params</code>: a type that contains the parameters used to initialize the client, which will be passed to <code>initClient</code>.
Use this to pass endpoint urls, the path to the cache or a authentication token to the other isolate. </li><li><code>messageHandler</code> (optional): a function which will be invoked on the main isolate if you send objects
through the <code>SendPort</code> passed to <code>initClient</code>. If you want to establish two-way communication, create a new <code>ReceivePort</code>
in <code>InitClient</code> and send its <code>SendPort</code> over the <code>SendPort</code> which is the third parameter of <code>initClient</code>. <code>messageHandler</code> will
be called with the <code>sendPort</code> and this can be used to send custom messages from the main isolate the the ferry isolate.</li></ul><p>A example can be found in <code>examples/pokemon_explorer</code>. In this project. The same App can be run with ferry
on the main isolate (<code>main.dart</code>) or a separate isolate (<code>main_isolate.dart</code>).</p><h3><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2cZh" id="caveats"></a>Caveats<a aria-hidden="true" tabindex="-1" class="hash-link" href="#caveats" title="Direct link to heading">#</a></h3><p>By default, you will not be able to run code that uses <code>MethodChannel</code>s underneath in the new isolate.
This means: </p><ul><li>no SharedPreferences</li><li>no Hive.initFlutter (Hive.init works, though, also in flutter apps.)</li><li>no path_provider</li></ul><p>If you want to use Hive for the cache, there is a workaround implemented in the pokemon_explorer example app:</p><ul><li>call <code> (await getApplicationDocumentsDirectory()).path</code> on the main isolate and pass the path to the ferry isolate in the <code>params</code> map</li><li>use <code>Hive.init</code> with the given path instead of <code>Hive.initFlutter()</code>. Note that Hive is single threaded and you cannot use the same box on multiple isolates, this would lead to data corruption.</li></ul><p>If you have an authenticated graphql api and need the auth token on both the main isolate and the ferry isolate, consider one of the following solutions:</p><ul><li>use a persistence library that can be used across different isolates like <code>drift</code> or <code>isar</code>. </li><li>use a persistence library like <code>hive</code>, which does not support multiple isolate, can be used on non-main isolates also. However,<br>With this approach, the Hive box needs to be opened on the ferry isolate only, the main isolate will not be able the read the auth token.</li><li>use the <code>SendPort</code> in the <code>InitClient</code> function that runs on the ferry isolate to establish communication between
the main isolate and ferry. For example you can send the new authentication token via that sendPort.
The main isolate would receive it in its <code>messageHandler</code> and could persist it, for example via <code>SharedPreferences</code>.
You can also establish a two-way communication be creating a <code>ReceivePort</code> in the <code>InitClient</code> function and send its sendport to
the main isolates messagehandler.</li></ul><p>Here&#x27;s an example on how to wire up SharedPreferences to store
the auth token on the main isolate, refresh it on the ferry isolate when needed, and
send the new token the the main isolate for shared_preferences to store:</p><p><a href="https://gist.github.com/knaeckeKami/b11ad83e4b69aa44638815d1471c2ba3" target="_blank" rel="noopener noreferrer">https://gist.github.com/knaeckeKami/b11ad83e4b69aa44638815d1471c2ba3</a></p><p>If you implement another approach, feel free to send me a sample code so I can add it here.</p></div></article><div class="margin-vert--xl"><div class="row"><div class="col"><a href="https://github.com/gql-dart/ferry/edit/master/docs/../docs/isolates.md" target="_blank" rel="noreferrer noopener"><svg fill="currentColor" height="1.2em" width="1.2em" preserveAspectRatio="xMidYMid meet" viewBox="0 0 40 40" style="margin-right:0.3em;vertical-align:sub"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></div></div><div class="margin-vert--lg"><nav class="pagination-nav" aria-label="Blog list page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/docs/customization"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« Customizing the Client</div></a></div><div class="pagination-nav__item pagination-nav__item--next"></div></nav></div></div></div><div class="col col--3"><div class="tableOfContents_3SO_"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#running-the-client-in-a-separate-isolate" class="table-of-contents__link">Running the client in a separate isolate</a><ul><li><a href="#setup" class="table-of-contents__link">Setup</a></li><li><a href="#caveats" class="table-of-contents__link">Caveats</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="row footer__links"><div class="col footer__col"><h4 class="footer__title">Docs</h4><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/">Introduction</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">Community</h4><ul class="footer__items"><li class="footer__item"><a href="https://discord.gg/G3JGkBY" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li></ul></div><div class="col footer__col"><h4 class="footer__title">More</h4><ul class="footer__items"><li class="footer__item"><a href="https://pub.dev/packages/ferry" target="_blank" rel="noopener noreferrer" class="footer__link-item">pub.dev</a></li><li class="footer__item"><a href="https://github.com/gql-dart/ferry" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub</a></li></ul></div></div><div class="text--center"><div>Copyright Â© 2022 Sat Mandir Khalsa. Built with Docusaurus.</div></div></div></footer></div>
<script src="/styles.f1bdf990.js"></script>
<script src="/runtime~main.e864399f.js"></script>
<script src="/main.60635ab2.js"></script>
<script src="/1.27e33db8.js"></script>
<script src="/2.040e9cea.js"></script>
<script src="/27.30f434e1.js"></script>
<script src="/30.fdbdcc2e.js"></script>
<script src="/935f2afb.03ea0236.js"></script>
<script src="/17896441.ff7edf47.js"></script>
<script src="/ad3276bd.0c495063.js"></script>
</body>
</html>