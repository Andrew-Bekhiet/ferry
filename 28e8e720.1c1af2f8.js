(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{62:function(e,t,a){"use strict";a.r(t),a.d(t,"frontMatter",(function(){return c})),a.d(t,"metadata",(function(){return o})),a.d(t,"rightToc",(function(){return s})),a.d(t,"default",(function(){return p}));var n=a(2),r=a(6),i=(a(0),a(85)),c={id:"mutations",title:"Mutations"},o={unversionedId:"mutations",id:"mutations",isDocsHomePage:!1,title:"Mutations",description:"Mutations are executed exactly the same way as queries:",source:"@site/../docs/mutations.md",slug:"/mutations",permalink:"/ferry/docs/mutations",editUrl:"https://github.com/gql-dart/ferry/edit/master/docs/../docs/mutations.md",version:"current",sidebar:"mainSidebar",previous:{title:"Queries",permalink:"/ferry/docs/queries"},next:{title:"Fetch Policies",permalink:"/ferry/docs/fetch-policies"}},s=[{value:"Creating a Request",id:"creating-a-request",children:[]},{value:"Listening to the Request Stream",id:"listening-to-the-request-stream",children:[]},{value:"Optimistic Updates",id:"optimistic-updates",children:[]},{value:"Updating the Cache",id:"updating-the-cache",children:[{value:"Creating an <code>UpdateCacheHandler</code>",id:"creating-an-updatecachehandler",children:[]},{value:"Passing Handlers to the Client",id:"passing-handlers-to-the-client",children:[]},{value:"Triggering a Handler",id:"triggering-a-handler",children:[]},{value:"Passing Data to a Handler",id:"passing-data-to-a-handler",children:[]}]}],l={rightToc:s};function p(e){var t=e.components,a=Object(r.a)(e,["components"]);return Object(i.b)("wrapper",Object(n.a)({},l,a,{components:t,mdxType:"MDXLayout"}),Object(i.b)("p",null,"Mutations are executed exactly the same way as ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/ferry/docs/queries"}),"queries"),":"),Object(i.b)("ol",null,Object(i.b)("li",{parentName:"ol"},"Create an instance of the ",Object(i.b)("a",Object(n.a)({parentName:"li"},{href:"/ferry/docs/codegen"}),"generated")," request class for your Mutation."),Object(i.b)("li",{parentName:"ol"},"Call ",Object(i.b)("inlineCode",{parentName:"li"},"Client.request()")," with your request instance."),Object(i.b)("li",{parentName:"ol"},"Listen to the returned Stream.")),Object(i.b)("h3",{id:"creating-a-request"},"Creating a Request"),Object(i.b)("p",null,"Let's assume we've created a ",Object(i.b)("inlineCode",{parentName:"p"},"CreateReview")," Mutation in a file named ",Object(i.b)("inlineCode",{parentName:"p"},"create_review.graphql"),"."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-graphql"}),"# create_review.graphql\n\nmutation CreateReview($review: ReviewInput!) {\n  createReview(review: $review) {\n    id\n    stars\n    commentary\n  }\n}\n")),Object(i.b)("p",null,"In this case, the review depends on ",Object(i.b)("inlineCode",{parentName:"p"},"ReviewInput")," which is defined in our schema:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-graphql"}),"# schema.graphql\n\ninput ReviewInput {\n  # 0-5 stars\n  stars: Int!\n  # Comment about the movie, optional\n  commentary: String\n}\n")),Object(i.b)("p",null,"Running the Ferry ",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/ferry/docs/codegen"}),"generator")," will create a ",Object(i.b)("inlineCode",{parentName:"p"},"create_review.req.gql.dart")," file with a Class named ",Object(i.b)("inlineCode",{parentName:"p"},"GCreateReviewReq"),". We can instantiate it like this:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart"}),'final createReviewReq = GCreateReviewReq(\n  (b) => b\n    ..vars.review.stars = 5\n    ..vars.review.commentary = "Amazing!!!",\n);\n')),Object(i.b)("h3",{id:"listening-to-the-request-stream"},"Listening to the Request Stream"),Object(i.b)("p",null,"Now we can execute the mutation and listen for a response like so:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart"}),"client.request(createReviewReq).listen((response) => print(response));\n")),Object(i.b)("h2",{id:"optimistic-updates"},"Optimistic Updates"),Object(i.b)("p",null,"We often want our users to be able to see changes they make within our applications instantly."),Object(i.b)("p",null,"To achieve this, we can provide our ",Object(i.b)("inlineCode",{parentName:"p"},"OperationRequest")," with an ",Object(i.b)("inlineCode",{parentName:"p"},"optimisticResponse"),", which will trigger an ",Object(i.b)("inlineCode",{parentName:"p"},"OperationResponse")," that includes the optimistic data immediately. Then, once the network response is received from the server, a second ",Object(i.b)("inlineCode",{parentName:"p"},"OperationResponse")," will be triggered with the network data."),Object(i.b)("p",null,"Using the example above, we could include an optimistic response like so:"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart",metastring:"{5}","{5}":!0}),'final createReviewReq = GCreateReviewReq(\n  (b) => b\n    ..vars.review.stars = 5\n    ..vars.review.commentary = "Amazing!!!"\n    ..optimisticResponse.createReview.id = "__optimistic__"\n    ..optimisticResponse.createReview.stars = 5\n    ..optimisticResponse.createReview.commentary = "Amazing!!!",\n);\n')),Object(i.b)("h2",{id:"updating-the-cache"},"Updating the Cache"),Object(i.b)("p",null,"Sometimes we need to update the cache in response to a mutation. Ferry allows arbitrary cache updates following any Operation using ",Object(i.b)("inlineCode",{parentName:"p"},"UpdateCacheHandler")," callbacks, which run whenever an ",Object(i.b)("inlineCode",{parentName:"p"},"OperationResponse")," is received."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart"}),"typedef UpdateCacheHandler<TData, TVars> = void Function(\n  CacheProxy proxy,\n  OperationResponse<TData, TVars> response,\n);\n")),Object(i.b)("p",null,"The ",Object(i.b)("inlineCode",{parentName:"p"},"CacheProxy")," passed to the handler includes methods to read & write data to & from the cache, including ",Object(i.b)("inlineCode",{parentName:"p"},"readQuery"),", ",Object(i.b)("inlineCode",{parentName:"p"},"readFragment"),", ",Object(i.b)("inlineCode",{parentName:"p"},"writeQuery")," and ",Object(i.b)("inlineCode",{parentName:"p"},"writeFragment"),"."),Object(i.b)("h3",{id:"creating-an-updatecachehandler"},"Creating an ",Object(i.b)("inlineCode",{parentName:"h3"},"UpdateCacheHandler")),Object(i.b)("p",null,"Continuing our example from above, we may want to update our",Object(i.b)("a",Object(n.a)({parentName:"p"},{href:"/ferry/docs/queries#creating-a-request"})," ",Object(i.b)("inlineCode",{parentName:"a"},"Reviews"))," Query with the result of executing the ",Object(i.b)("inlineCode",{parentName:"p"},"CreateReview")," Mutation. To do so, we'd write the following ",Object(i.b)("inlineCode",{parentName:"p"},"UpdateCacheHandler"),":"),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart"}),"import './graphql/create_review.data.gql.dart';\nimport './graphql/create_review.var.gql.dart';\n\nUpdateCacheHandler<GCreateReviewData, GCreateReviewVars> createReviewHandler = (\n  proxy,\n  response,\n) {\n  final reviews = proxy.readQuery(reviewsReq) ?? GReviewsData();\n  proxy.writeQuery(\n    reviewsReq,\n    reviews.rebuild(\n      (b) => b\n        ..reviews.add(\n          GReviewsData_reviews.fromJson(\n            response.data.createReview.toJson(),\n          ),\n        ),\n    ),\n  );\n};\n")),Object(i.b)("div",{className:"admonition admonition-note alert alert--secondary"},Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"14",height:"16",viewBox:"0 0 14 16"}),Object(i.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"})))),"note")),Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"Since Dart doesn't yet have algebraic data types, to avoid receiving a type error we must convert our ",Object(i.b)("inlineCode",{parentName:"p"},"GCreateReviewData")," to Json, then convert it back from Json to a ",Object(i.b)("inlineCode",{parentName:"p"},"GReviewsData_reviews")," type before adding it to our reviews list."))),Object(i.b)("h3",{id:"passing-handlers-to-the-client"},"Passing Handlers to the Client"),Object(i.b)("p",null,"If Ferry, the client must be aware of all ",Object(i.b)("inlineCode",{parentName:"p"},"UpdateCacheHandler"),"s. This is slightly different from how other GraphQL clients (like Apollo) work, but it's necessary to enable features such as offline mutations."),Object(i.b)("p",null,"Now that we've created our ",Object(i.b)("inlineCode",{parentName:"p"},"createReviewHandler"),", we can add it to our Client using the key ",Object(i.b)("inlineCode",{parentName:"p"},'"createReviewHandler"'),", which we'll later use to trigger this handler from our mutation request."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart"}),"import 'package:gql_http_link/gql_http_link.dart';\nimport 'package:ferry/ferry.dart';\nimport 'package:ferry/plugins.dart';\n\nfinal link = HttpLink(\"[path/to/endpoint]\");\n\nfinal client = Client(\n  link: link,\n  cache: cache,\n  updateCacheHandlers: {\n    'createReviewHandler': createReviewHandler,\n  },\n);\n")),Object(i.b)("h3",{id:"triggering-a-handler"},"Triggering a Handler"),Object(i.b)("p",null,"Now we can tell Ferry to trigger our handler when it receives an ",Object(i.b)("inlineCode",{parentName:"p"},"OperationResponse")," for our mutation."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart",metastring:"{8}","{8}":!0}),'final createReviewReq = GCreateReviewReq(\n  (b) => b\n    ..vars.review.stars = 5\n    ..vars.review.commentary = "Amazing!!!"\n    ..optimisticResponse.createReview.id = "__optimistic__"\n    ..optimisticResponse.createReview.stars = 5\n    ..optimisticResponse.createReview.commentary = "Amazing!!!"\n    ..updateCacheHandlerKey = "createReviewHandler",\n);\n')),Object(i.b)("p",null,"Since our mutation request includes an optimistic response, our handler will first be run as an optimistic patch using the optimistic data. When the network response is received from the server, the optimistic patch will be discarded and the handler will be run again with the response data from the network."),Object(i.b)("h3",{id:"passing-data-to-a-handler"},"Passing Data to a Handler"),Object(i.b)("p",null,"If you need to pass any contextual data to your handler, Ferry allows you to include a Json Map in your request."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart",metastring:"{9}","{9}":!0}),'final createReviewReq = GCreateReviewReq(\n  (b) => b\n    ..vars.review.stars = 5\n    ..vars.review.commentary = "Amazing!!!"\n    ..optimisticResponse.createReview.id = "__optimistic__"\n    ..optimisticResponse.createReview.stars = 5\n    ..optimisticResponse.createReview.commentary = "Amazing!!!"\n    ..updateCacheHandlerKey = "createReviewHandler"\n    ..updateCacheHandlerContext = { "userId": "123" },\n);\n')),Object(i.b)("p",null,"The data can then be accessed from inside the handler."),Object(i.b)("pre",null,Object(i.b)("code",Object(n.a)({parentName:"pre"},{className:"language-dart"}),'UpdateCacheHandler<GCreateReviewData, GCreateReviewVars> createReviewHandler = (\n  proxy,\n  response,\n) {\n  final userId = response.operationRequest.updateCacheHandlerContext["userId"];\n  /// [Your Handler Logic]\n};\n')),Object(i.b)("div",{className:"admonition admonition-caution alert alert--warning"},Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-heading"}),Object(i.b)("h5",{parentName:"div"},Object(i.b)("span",Object(n.a)({parentName:"h5"},{className:"admonition-icon"}),Object(i.b)("svg",Object(n.a)({parentName:"span"},{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",viewBox:"0 0 16 16"}),Object(i.b)("path",Object(n.a)({parentName:"svg"},{fillRule:"evenodd",d:"M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"})))),"caution")),Object(i.b)("div",Object(n.a)({parentName:"div"},{className:"admonition-content"}),Object(i.b)("p",{parentName:"div"},"If you need offline mutation support, be sure to only include valid Json in the ",Object(i.b)("inlineCode",{parentName:"p"},"updateCacheHandlerContext"),", since this will need to be serialized"))))}p.isMDXComponent=!0},85:function(e,t,a){"use strict";a.d(t,"a",(function(){return d})),a.d(t,"b",(function(){return m}));var n=a(0),r=a.n(n);function i(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function c(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?c(Object(a),!0).forEach((function(t){i(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):c(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function s(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},i=Object.keys(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(n=0;n<i.length;n++)a=i[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var l=r.a.createContext({}),p=function(e){var t=r.a.useContext(l),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},d=function(e){var t=p(e.components);return r.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return r.a.createElement(r.a.Fragment,{},t)}},u=r.a.forwardRef((function(e,t){var a=e.components,n=e.mdxType,i=e.originalType,c=e.parentName,l=s(e,["components","mdxType","originalType","parentName"]),d=p(a),u=n,m=d["".concat(c,".").concat(u)]||d[u]||b[u]||i;return a?r.a.createElement(m,o(o({ref:t},l),{},{components:a})):r.a.createElement(m,o({ref:t},l))}));function m(e,t){var a=arguments,n=t&&t.mdxType;if("string"==typeof e||n){var i=a.length,c=new Array(i);c[0]=u;var o={};for(var s in t)hasOwnProperty.call(t,s)&&(o[s]=t[s]);o.originalType=e,o.mdxType="string"==typeof e?e:n,c[1]=o;for(var l=2;l<i;l++)c[l]=a[l];return r.a.createElement.apply(null,c)}return r.a.createElement.apply(null,a)}u.displayName="MDXCreateElement"}}]);