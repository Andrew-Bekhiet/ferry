(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{72:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return r})),n.d(t,"metadata",(function(){return l})),n.d(t,"rightToc",(function(){return s})),n.d(t,"default",(function(){return p}));var a=n(2),i=n(6),o=(n(0),n(86)),r={id:"isolates",title:"Running the client in a separate isolate",sidebar_label:"Isolates"},l={unversionedId:"isolates",id:"isolates",isDocsHomePage:!1,title:"Running the client in a separate isolate",description:"Running the client in a separate isolate",source:"@site/../docs/isolates.md",slug:"/isolates",permalink:"/docs/isolates",editUrl:"https://github.com/gql-dart/ferry/edit/master/docs/../docs/isolates.md",version:"current",sidebar_label:"Isolates",sidebar:"mainSidebar",previous:{title:"Customizing the Client",permalink:"/docs/customization"}},s=[{value:"Running the client in a separate isolate",id:"running-the-client-in-a-separate-isolate",children:[{value:"Setup",id:"setup",children:[]},{value:"Caveats",id:"caveats",children:[]}]}],c={rightToc:s};function p(e){var t=e.components,n=Object(i.a)(e,["components"]);return Object(o.b)("wrapper",Object(a.a)({},c,n,{components:t,mdxType:"MDXLayout"}),Object(o.b)("h2",{id:"running-the-client-in-a-separate-isolate"},"Running the client in a separate isolate"),Object(o.b)("p",null,"The default setup should be sufficient for most use cases.\nHowever, normalization and denormalization of big, nested responses can be quite computation heavy\nand can lead to dropped frames on frontends."),Object(o.b)("p",null,"Ferry can help you run your graphql-related code on a separate isolate so that the UI thread does\nnot get blocked when executing big queries."),Object(o.b)("p",null,"Since the Ferry ",Object(o.b)("inlineCode",{parentName:"p"},"Client")," already is Stream based, the differences in the API between the default ",Object(o.b)("inlineCode",{parentName:"p"},"Client")," and the ",Object(o.b)("inlineCode",{parentName:"p"},"IsolateClient")," are minimal.\nIf you are just using the ",Object(o.b)("inlineCode",{parentName:"p"},"request()")," method of the ",Object(o.b)("inlineCode",{parentName:"p"},"Client")," or ",Object(o.b)("inlineCode",{parentName:"p"},"Operation")," widgets of ferry_flutter,\nthen the ",Object(o.b)("inlineCode",{parentName:"p"},"IsolateClient")," is a drop-in replacement! "),Object(o.b)("p",null,"The ",Object(o.b)("inlineCode",{parentName:"p"},"IsolateClient")," does not, however, offer direct access to the ",Object(o.b)("inlineCode",{parentName:"p"},"Cache")," object, but instead offers\nindirect access via methods like ",Object(o.b)("inlineCode",{parentName:"p"},"readQuery()")," or ",Object(o.b)("inlineCode",{parentName:"p"},"writeFragment()"),". These methods are asynchronous,\nas all communication over isolates is asynchrounous."),Object(o.b)("h3",{id:"setup"},"Setup"),Object(o.b)("p",null,"To run Ferry on a separate Isolate, use the static ",Object(o.b)("inlineCode",{parentName:"p"},"IsolateClient.create<InitParams>()")," method.\nThis method receives three parameters and one generic type parameter:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"<InitParams>"),": this generic type parameter defines the type of the parameters object which is used\nto initialze the client. If you don't want to write a separate class for this, you can just use ",Object(o.b)("inlineCode",{parentName:"li"},"Map<String, dynamic>")," here.\nIf you don't need parameters to initialize the Client, you can also use the ",Object(o.b)("inlineCode",{parentName:"li"},"Null")," type"),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"initClient"),": This function is called on a separate isolate and is responsible for creating the real Ferry ",Object(o.b)("inlineCode",{parentName:"li"},"Client"),".\nThis must be a top-level or static function (otherwise it will not be possible to send it to another isolate).\nWhen migrating from the standard setup to to isolate-based setup, move the initialization of the ",Object(o.b)("inlineCode",{parentName:"li"},"Client")," class\nto this function. initClient is also called with a ",Object(o.b)("inlineCode",{parentName:"li"},"SendPort")," parameter, which can be used to establish custom\ncommunication between the two isolates. You can use this for example for synchronizing authentication tokens when\nthe are refreshed. "),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"params"),": a type that contains the parameters used to initialize the client, which will be passed to ",Object(o.b)("inlineCode",{parentName:"li"},"initClient"),".\nUse this to pass endpoint urls, the path to the cache or a authentication token to the other isolate. "),Object(o.b)("li",{parentName:"ul"},Object(o.b)("inlineCode",{parentName:"li"},"messageHandler")," (optional): a function which will be invoked on the main isolate if you send objects\nthrough the ",Object(o.b)("inlineCode",{parentName:"li"},"SendPort")," passed to ",Object(o.b)("inlineCode",{parentName:"li"},"initClient"),". If you want to establish two-way communication, create a new ",Object(o.b)("inlineCode",{parentName:"li"},"ReceivePort"),"\nin ",Object(o.b)("inlineCode",{parentName:"li"},"InitClient")," and send its ",Object(o.b)("inlineCode",{parentName:"li"},"SendPort")," over the ",Object(o.b)("inlineCode",{parentName:"li"},"SendPort")," which is the third parameter of ",Object(o.b)("inlineCode",{parentName:"li"},"initClient"),". ",Object(o.b)("inlineCode",{parentName:"li"},"messageHandler")," will\nbe called with the ",Object(o.b)("inlineCode",{parentName:"li"},"sendPort")," and this can be used to send custom messages from the main isolate the the ferry isolate.")),Object(o.b)("p",null,"A example can be found in ",Object(o.b)("inlineCode",{parentName:"p"},"examples/pokemon_explorer"),". In this project. The same App can be run with ferry\non the main isolate (",Object(o.b)("inlineCode",{parentName:"p"},"main.dart"),") or a separate isolate (",Object(o.b)("inlineCode",{parentName:"p"},"main_isolate.dart"),")."),Object(o.b)("h3",{id:"caveats"},"Caveats"),Object(o.b)("p",null,"By default, you will not be able to run code that uses ",Object(o.b)("inlineCode",{parentName:"p"},"MethodChannel"),"s underneath in the new isolate.\nThis means: "),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"no SharedPreferences"),Object(o.b)("li",{parentName:"ul"},"no Hive.initFlutter (Hive.init works, though, also in flutter apps.)"),Object(o.b)("li",{parentName:"ul"},"no path_provider")),Object(o.b)("p",null,"If you want to use Hive for the cache, there is a workaround implemented in the pokemon_explorer example app:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"call ",Object(o.b)("inlineCode",{parentName:"li"}," (await getApplicationDocumentsDirectory()).path")," on the main isolate and pass the path to the ferry isolate in the ",Object(o.b)("inlineCode",{parentName:"li"},"params")," map"),Object(o.b)("li",{parentName:"ul"},"use ",Object(o.b)("inlineCode",{parentName:"li"},"Hive.init")," with the given path instead of ",Object(o.b)("inlineCode",{parentName:"li"},"Hive.initFlutter()"),". Note that Hive is single threaded and you cannot use the same box on multiple isolates, this would lead to data corruption.")),Object(o.b)("p",null,"If you have an authenticated graphql api and need the auth token on both the main isolate and the ferry isolate, consider one of the following solutions:"),Object(o.b)("ul",null,Object(o.b)("li",{parentName:"ul"},"use a persistence library that can be used across different isolates like ",Object(o.b)("inlineCode",{parentName:"li"},"drift")," or ",Object(o.b)("inlineCode",{parentName:"li"},"isar"),". "),Object(o.b)("li",{parentName:"ul"},"use a persistence library like ",Object(o.b)("inlineCode",{parentName:"li"},"hive"),", which does not support multiple isolate, can be used on non-main isolates also. However,",Object(o.b)("br",{parentName:"li"}),"With this approach, the Hive box needs to be opened on the ferry isolate only, the main isolate will not be able the read the auth token."),Object(o.b)("li",{parentName:"ul"},"use the ",Object(o.b)("inlineCode",{parentName:"li"},"SendPort")," in the ",Object(o.b)("inlineCode",{parentName:"li"},"InitClient")," function that runs on the ferry isolate to establish communication between\nthe main isolate and ferry. For example you can send the new authentication token via that sendPort.\nThe main isolate would receive it in its ",Object(o.b)("inlineCode",{parentName:"li"},"messageHandler")," and could persist it, for example via ",Object(o.b)("inlineCode",{parentName:"li"},"SharedPreferences"),".\nYou can also establish a two-way communication be creating a ",Object(o.b)("inlineCode",{parentName:"li"},"ReceivePort")," in the ",Object(o.b)("inlineCode",{parentName:"li"},"InitClient")," function and send its sendport to\nthe main isolates messagehandler.")),Object(o.b)("p",null,"Here's an example on how to wire up SharedPreferences to store\nthe auth token on the main isolate, refresh it on the ferry isolate when needed, and\nsend the new token the the main isolate for shared_preferences to store:"),Object(o.b)("p",null,Object(o.b)("a",Object(a.a)({parentName:"p"},{href:"https://gist.github.com/knaeckeKami/b11ad83e4b69aa44638815d1471c2ba3"}),"https://gist.github.com/knaeckeKami/b11ad83e4b69aa44638815d1471c2ba3")),Object(o.b)("p",null,"If you implement another approach, feel free to send me a sample code so I can add it here."))}p.isMDXComponent=!0},86:function(e,t,n){"use strict";n.d(t,"a",(function(){return b})),n.d(t,"b",(function(){return h}));var a=n(0),i=n.n(a);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function s(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var c=i.a.createContext({}),p=function(e){var t=i.a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},b=function(e){var t=p(e.components);return i.a.createElement(c.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return i.a.createElement(i.a.Fragment,{},t)}},u=i.a.forwardRef((function(e,t){var n=e.components,a=e.mdxType,o=e.originalType,r=e.parentName,c=s(e,["components","mdxType","originalType","parentName"]),b=p(n),u=a,h=b["".concat(r,".").concat(u)]||b[u]||d[u]||o;return n?i.a.createElement(h,l(l({ref:t},c),{},{components:n})):i.a.createElement(h,l({ref:t},c))}));function h(e,t){var n=arguments,a=t&&t.mdxType;if("string"==typeof e||a){var o=n.length,r=new Array(o);r[0]=u;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:a,r[1]=l;for(var c=2;c<o;c++)r[c]=n[c];return i.a.createElement.apply(null,r)}return i.a.createElement.apply(null,n)}u.displayName="MDXCreateElement"}}]);